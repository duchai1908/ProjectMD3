<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!-- Mirrored from htmldemo.net/pebona/pebona/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 28 Mar 2023 20:51:52 GMT -->
<head th:insert="/user/layout/layout::head-link">

</head>

<body>

<!--[if lt IE 9]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please upgrade your browser to improve
    your experience.</p>
<![endif]-->

<!-- Start of Whole Site Wrapper with mobile menu support -->
<div id="whole" class="whole-site-wrapper">

    <!-- Start of Newsletter Popup and Header -->

    <th:block th:replace="/user/layout/layout::news-and-header"></th:block>
    <!-- Start of Breadcrumbs -->
    <div class="breadcrumb-section bgc-offset mb-full">
        <div class="container">
            <div class="row">
                <div class="col-12 col-sm-12 col-md-12">
                    <nav class="breadcrumb">
                        <a class="breadcrumb-item" th:href="@{/index}">Home</a>
                        <span class="breadcrumb-item active">Shopping Cart</span>
                    </nav>
                </div>
            </div> <!-- end of row -->
        </div> <!-- end of container -->
    </div>
    <!-- End of Breadcrumbs -->

    <!-- Start of Main Content Wrapper -->
    <div id="content" class="main-content-wrapper">

        <!-- Start of Shopping Cart Wrapper -->
        <div class="shopping-cart-wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                        <main id="primary" class="site-main">
                            <div class="shopping-cart">
                                <div class="row">
                                    <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                                        <div class="section-title">
                                            <h2>Shopping Cart</h2>
                                        </div>
                                        <div style="width: 100%; display: flex; align-items: center; justify-content: flex-end; margin-bottom: 40px;">
                                            <button style="width: 150px; height: 70px; " th:onclick="|deleteAll(${userId})|">Delete All</button>
                                        </div>
                                        <form action="#">
                                            <div class="table-responsive">
                                                <table class="table table-bordered">
                                                    <thead>
                                                    <tr>
                                                        <td>Image</td>
                                                        <td>Product Name</td>
                                                        <td>Quantity</td>
                                                        <td>Unit Price</td>
                                                        <td>Total</td>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr th:each="c:${cartItems}" th:id="'cartItemRow' + ${c.id}">
                                                        <td>
                                                            <a th:href="'@{/product-detail/' + ${c.product.id}"><img
                                                                    th:src="${productImagesMap[c.product.id]?.imageUrl}"
                                                                    alt="Cart Product Image" title="Compete Track Tote"
                                                                    class="img-thumbnail"></a>
                                                        </td>
                                                        <td>
                                                            <a th:href="'@{/product-detail/' + ${c.product.id}" th:text="${c.product.product.name}"></a>
<!--                                                            <span>Delivery Date: 2018-09-22</span>-->
                                                            <span th:text="'Color: ' + ${c.product.color.color}"></span>
                                                        </td>
                                                        <td>
                                                            <div class="input-group btn-block">
                                                                <div class="cart-input">
                                                                    <input class="cart-input-box" type="text" th:value="${c.quantity}" th:id="'quantityInput' + ${c.product.id}"/>
                                                                    <div class="dec qtybutton"><i class="fa fa-angle-down"></i></div>
                                                                    <div class="inc qtybutton"><i class="fa fa-angle-up"></i></div>
                                                                </div>
                                                                <span class="input-group-btn">
                                                                    <button th:onclick="|updatePrice(event,${c.product.id})|"
                                                                            type="button"
                                                                            data-bs-toggle="tooltip"
                                                                            data-direction="top"
                                                                            class="btn btn-primary"
                                                                            data-original-title="Update"><i class="fa fa-refresh"></i></button>
                                                                    <button th:onclick="|deleteProductDetail(${c.id})|"
                                                                            type="button"
                                                                            data-bs-toggle="tooltip"
                                                                            data-direction="top"
                                                                            class="btn btn-danger pull-right"
                                                                            data-original-title="Remove"><i class="fa fa-times-circle"></i></button>
                                                                </span>
                                                            </div>
                                                        </td>
                                                        <td><span th:id="'priceUnit' + ${c.product.id}" th:data-price="${c.product.price}"
                                                                  th:text="${#numbers.formatDecimal(c.product.price, 0, 'COMMA', 0, 'POINT')}"></span> VND</td>
                                                        <td><span th:id="'totalPrice'+${c.product.id}"
                                                                  class="product-total-price"
                                                                  th:text="${#numbers.formatDecimal(c.product.price * c.quantity, 0, 'COMMA', 0, 'POINT')}"></span> VND</td>
                                                    </tr>


                                                    </tbody>
                                                </table>
                                            </div>
                                        </form>

                                        <div class="cart-accordion-wrapper mt-full">
                                            <h2>What would you like to do next?</h2>
                                            <p>Choose if you have a discount code or reward points you want to use or
                                                would like to estimate your delivery cost.</p>
                                            <div id="cart_accordion" class="mt-4" role="tablist">
                                                <div class="card">
                                                    <div class="card-header" role="tab" id="headingCoupon">
                                                        <h4 class="mb-0">
                                                            <a data-bs-toggle="collapse" href="#collapseCoupon"
                                                               aria-expanded="false" aria-controls="collapseCoupon">Use
                                                                Coupon Code<i class="ion ion-ios-arrow-down"></i></a>
                                                        </h4>
                                                    </div>
                                                    <div id="collapseCoupon" class="collapse" role="tabpanel"
                                                         aria-labelledby="headingCoupon"
                                                         data-bs-parent="#cart_accordion">
                                                        <div class="card-body">
                                                            <div class="input-group">
                                                                <label class="col-12 col-sm-12 col-md-3"
                                                                       for="input-coupon">Enter your coupon here</label>
                                                                <div class="col-12 col-sm-12 col-md-9">
                                                                    <div class="input-group">
                                                                        <input type="text" name="coupon" value=""
                                                                               placeholder="Enter your coupon here"
                                                                               id="input-coupon" class="form-control">
                                                                        <input type="button" value="Apply Coupon"
                                                                               id="button-coupon"
                                                                               class="btn btn-secondary">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cart-amount-wrapper">
                                            <div class="row">
                                                <div class="col-12 col-sm-12 col-md-4 offset-md-8">
                                                    <table class="table table-bordered">
                                                        <tbody>
                                                        <tr>
                                                            <td><strong>Sub-Total:</strong></td>
                                                            <td><span id="subTotal" class="color-primary" th:name="subTotal">0 VND</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Total:</strong></td>
                                                            <td><span id="total" class="color-primary" th:name="total">0 VND</span></td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="cart-button-wrapper d-flex justify-content-between mt-4">
                                            <a th:href="@{/list-products}" class="btn btn-secondary dark">Continue
                                                Shopping</a>
                                            <a th:href="@{/checkout/3}" class="btn btn-secondary dark align-self-end">Checkout</a>
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- end of shopping-cart -->
                        </main> <!-- end of #primary -->
                    </div>
                </div> <!-- end of row -->
            </div> <!-- end of container -->
        </div>
        <!-- End of Shopping Cart Wrapper -->
    </div>
    <!-- End of Main Content Wrapper -->

    <!-- Start of Footer -->
    <th:block th:replace="/user/layout/layout::footer"></th:block>
    <!-- End of Footer -->


    <!-- Start of Scroll to Top -->
    <div id="to_top">
        <i class="ion ion-ios-arrow-forward"></i>
        <i class="ion ion-ios-arrow-forward"></i>
    </div>
    <!-- End of Scroll to Top -->
</div>
<!-- End of Whole Site Wrapper -->

<!-- Initializing Photoswipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<!-- End of Photoswipe -->


<!-- JS
============================================ -->
<th:block th:replace="/user/layout/layout::plugins-jss-link"></th:block>

<script>
    calculateTotal();
    function updatePrice(event,id){
        let quantity;
        if(event.target.classList.contains("fa")){
            console.log(event.target.parentElement.parentElement.parentElement.children[0].children[0]);
            quantity = event.target.parentElement.parentElement.parentElement.children[0].children[0].value;

        }else {
            console.log(event.target.parentElement.parentElement.children[0].children[0])
            quantity =event.target.parentElement.parentElement.children[0].children[0].value;
        }
        console.log("quantity: " +quantity);
        console.log("id = " +id);
        let productDetailId = id;

        // Get the price per unit for the product with the given id
        let priceUnit = document.getElementById("priceUnit" + id).getAttribute('data-price');

        // Calculate the total price
        let totalPrice = parseFloat(priceUnit) * parseInt(quantity);

        // take total price input
        let priceAfter = document.getElementById("totalPrice" + id);
        priceAfter.textContent = totalPrice.toLocaleString('vi-VN');

        // Send the updated quantity to the server
        updateQuantityInDatabase(id, quantity);

        //calculateTotal all total
        calculateTotal();
    }

    function updateQuantityInDatabase(productId, quantity) {
        fetch('/updateQuantity/1', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'productId': productId,
                'quantity': quantity
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update quantity');
                }
                return response.text();
            })
            .then(data => {
                console.log(data); // Log success message
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function calculateTotal(){
        let total =0;

        // Select all elements with class 'product-total-price'
        const totalPrices = document.querySelectorAll('.product-total-price');

        // Sum up the values of all total prices
        totalPrices.forEach(function(priceElement) {
            // Extract the numeric value from the price text content
            let price = parseFloat(priceElement.textContent.replace(/[^0-9]/g, ''));
            if (!isNaN(price)) {
                total += price;
            }
        });

        // Update the subtotal and total in the DOM
        document.getElementById('subTotal').textContent = total.toLocaleString('vi-VN') + " VND";
        document.getElementById('total').textContent = total.toLocaleString('vi-VN') + " VND";
    }

    function deleteProductDetail(id){
        console.log("Deleting CartItem with ID: " + id);

        fetch('/delete/' + id, {
            method: 'DELETE',
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete CartItem');
                }
                return response.text();
            })
            .then(data => {
                console.log(data); // Log success message

                // Optionally remove the CartItem row from the DOM
                const cartItemRow = document.getElementById('cartItemRow' + id);
                if (cartItemRow) {
                    cartItemRow.remove();
                }

                // Recalculate the total after deletion
                calculateTotal();
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function deleteAll(userId) {
        console.log("tram anh");
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: "btn btn-success",
                cancelButton: "btn btn-danger"
            },
            buttonsStyling: false
        });

        swalWithBootstrapButtons.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete all!",
            cancelButtonText: "No, cancel!",
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Make an AJAX request to delete all cart items for the user
                fetch(`/shopping-cart/delete-all/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            swalWithBootstrapButtons.fire({
                                title: "Deleted!",
                                text: "All items have been deleted.",
                                icon: "success"
                            });
                            // Optionally, you can refresh the page or remove all cart items from the DOM
                            location.reload();
                        } else {
                            throw new Error('Failed to delete items');
                        }
                    })
                    .catch(error => {
                        swalWithBootstrapButtons.fire({
                            title: "Error!",
                            text: "There was an error deleting the items.",
                            icon: "error"
                        });
                    });
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                swalWithBootstrapButtons.fire({
                    title: "Cancelled",
                    text: "Your items are safe :)",
                    icon: "error"
                });
            }
        });
    }
</script>

</body>

</html>