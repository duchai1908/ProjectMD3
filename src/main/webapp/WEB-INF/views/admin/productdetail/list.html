<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="content mt-3" th:fragment="list-productdetail">
    <div class="col-lg-12" style="padding-bottom:120px">
        <button style="padding: 10px 30px ; border-radius: 5px; margin-bottom: 16px;"
                class="btn btn-success"
                data-toggle="modal" data-target="#exampleModal"
                data-whatever="@mdo"
                th:onclick="resetForm()"
        >ADD
        </button>
        <table class="table table-striped table-bordered table-hover text-center">
            <thead>
            <tr align="center">
                <th>No</th>
                <th>Product</th>
                <th>Size</th>
                <th>Color</th>
                <th>Detail</th>
                <th colspan="2">Action</th>
            </tr>
            </thead>
            <tbody id="list-admin">
            <tr th:each="productDetail, loop :${listProductDetail}" th:id="'row-' + ${productDetail.id}">
                <td th:text="${currentPage * size + loop.count }"></td>
                <th th:text="${productDetail.product.name}"></th>
                <th th:text="${productDetail.size.name}"></th>
                <th th:text="${productDetail.color.color}"></th>
                <td class="center">
                    <button type="button" class="btn btn-primary btn-detail" id="btn-detail"
                             data-toggle="modal" data-target="#detailProduct"
                            data-whatever="@mdo"
                            th:data-prid = "${productDetail.id}"
                            th:data-price="${productDetail.price}"
                            th:data-quantity="${productDetail.quantity}">
                        <i class="fa fa-list-alt"></i>
                    </button>
                </td>
                <td class="center">
                    <button type="button" class="btn btn-danger" th:onclick="'deleteProductDetail(' + ${productDetail.id} + ')'"><i
                            class="fa fa-trash-o  fa-fw"></i></button>
                </td>
                <td class="center">
                    <button type="button" id="btn-initupdate"
                            class="btn btn-success btn-edit" data-toggle="modal" data-target="#exampleModal"
                            data-whatever="@mdo"
                            th:data-id = "${productDetail.id}"
                            th:data-price = "${productDetail.price}"
                            th:data-quantity="${productDetail.quantity}"
                            th:data-size ="${productDetail.size.id}"
                            th:data-color ="${productDetail.color.id}"
                            >
                        <i class="fa fa-pencil fa-fw"></i>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <!-- pagination -->
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <li th:if="${currentPage>0}" class="page-item">
                    <a class="page-link"
                       th:href="@{/admin/product/list(page=${currentPage - 1},size=${size})}">Previous</a>
                </li>
                <li class="page-item" th:each="pageNum : ${#numbers.sequence(1,totalPages)}">
                    <a class="page-link" th:href="@{/admin/product/list(page= ${pageNum - 1}, size=${size})}"
                       th:text="${pageNum}"
                       th:classappend="${pageNum == currentPage ? 'active': ''}">
                    </a>
                </li>

                <li th:if="${currentPage < totalPages - 1}" class="page-item">
                    <a class="page-link" th:href="@{/admin/product/list(page=${currentPage + 1},size=${size})}">Next</a>
                </li>
            </ul>
        </nav>

        <!-- Model Add ProductDetail -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <p id="changeStatus">ADD</p>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="updateForm" method="post" action="/admin/productdetail/add"
                          th:object="${productDetailRequest}" enctype="multipart/form-data">
                        <div class="modal-body">
                            <input type="hidden" id="colorId" name="product" th:value="${productId}">
                            <input type="hidden" id="prdetailid" name="prdtid">
                            <div class="form-group">
                                <label class="col-form-label">New size : </label>
                                <input th:type="radio" style="margin: 0 8px" th:each="sizes : ${sizeService}"
                                       th:value="${sizes.id}" id="size" name="size" th:text="${sizes.name}">
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label">New Colors: </label>
                                <input th:type="radio" id="color" name="color" th:each="colors: ${colorService}"
                                       th:value="${colors.id}" th:text="${colors.color}">
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label">New Price: </label>
                                <input th:type="number" id="price" th:field="*{price}">
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label">New Quantity: </label>
                                <input th:type="number" id="quantity" th:field="*{quantity}">
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label">Sub Image: </label>
                                <input th:type="file" id="file-input" th:multiple="multiple" name="image">
                            </div>
                            <div id="previewImage"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success" id="btn-update">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Model Detail ProductDetail -->
        <div class="modal fade" id="detailProduct" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <p>Detail</p>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label"> Price: </label>
                                <label class="col-form-label" id="detailPrice"></label>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label"> Quantity: </label>
                                <label class="col-form-label" id="detailQuantity"></label>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="col-form-label">Sub Image: </label>
                                <div id="subImage"></div>
                            </div>
                        </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" th:inline="javascript">
            /*<![CDATA[*/
            var categories = /*[[${listImage}]]*/ [];
            /*]]>*/
            console.log(categories); // Now you should see the actual data
            const detailButtons = document.querySelectorAll('.btn-detail')
            const detailPrice = document.getElementById("detailPrice")
            const detailQuantity = document.getElementById("detailQuantity")
            const subImage = document.getElementById("subImage");
            const editButtons = document.querySelectorAll('.btn-edit')
            const sizePr = document.getElementsByName("size")
            const colorPr = document.getElementsByName("color")
            const pricePr = document.getElementById("price")
            const quantityPr = document.getElementById("quantity")
            const productDetailId = document.getElementById("prdetailid")
            const changeStt = document.getElementById("changeStatus");
            const changeButton = document.getElementById("btn-update");
            productDetailId.value=0;

            // Resetform khi ấn vào nút ADD
            function resetForm(){
                document.getElementById("updateForm").reset();
                changeStt.innerHTML = "ADD";
                changeButton.innerHTML = "ADD";
            }

            // Hien thi anh vua chon o button ADD
            document.getElementById("file-input").addEventListener("change", function (event) {
                const files = event.target.files;
                const preview = document.getElementById('previewImage');
                preview.innerHTML = '';
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.width = '100px';
                            img.style.height = '100px';
                            img.style.objectFit = 'cover';
                            preview.appendChild(img);
                        }
                        reader.readAsDataURL(file);
                    }
                }
            })

            //Hien thi model detail productDetail
            detailButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    subImage.innerHTML="";
                    var dataPrice = this.dataset.price;
                    var dataQuantity = this.dataset.quantity;
                    var prId = this.dataset.prid;
                    detailPrice.innerHTML = dataPrice;
                    detailQuantity.innerHTML = dataQuantity;
                    for(let i = 0; i<categories.length;i++){
                        if(prId == categories[i].productDetail.id){
                            const img = document.createElement('img');
                            img.src = categories[i].imageUrl;
                            img.style.width = '100px';
                            img.style.height = '100px';
                            img.style.objectFit = 'cover';
                            subImage.appendChild(img);
                        }
                    }
                });
            });

            //hien thi model edit productDetail
            editButtons.forEach(button=> {
                button.addEventListener('click',function (event) {
                    changeStt.innerHTML = "UPDATE";
                    changeButton.innerHTML = "UPDATE";
                    colorPr.value = this.dataset.color
                    pricePr.value = this.dataset.price
                    quantityPr.value = this.dataset.quantity
                    productDetailId.value = this.dataset.id
                    for(let i = 0;i < sizePr.length;i++){
                        if(sizePr[i].value == this.dataset.size){
                            sizePr[i].checked = true;
                        }
                    }
                    for(let i = 0;i < colorPr.length;i++){
                        if(colorPr[i].value == this.dataset.color){
                            colorPr[i].checked = true;
                        }
                    }
                })
            })

            // Xoá productDetail
            function deleteProductDetail(id){
                Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        // thực hiện ajax
                        fetch(`/admin/productdetail/delete/` +id, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => {
                                if (response.ok) {
                                    const row = document.getElementById(`row-`+id);
                                    if (row) {
                                        row.remove();
                                    }
                                    Swal.fire({
                                        title: "Deleted!",
                                        text: "Your ProductDetail has been deleted.",
                                        icon: "success"
                                    });
                                } else {
                                    throw new Error('Failed to delete the Size');
                                }
                            })
                    }
                });
            }
        </script>

    </div>
</div>
</body>
</html>