<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Size</title>
</head>
<body>
    <div class="content mt-3" th:fragment="list-size">
    <table id="example1" class="table table-bordered table-striped text-center">
        <thead>
        <tr>
            <th>No</th>
            <th>Name</th>
            <th>Created At</th>
            <th>Update At</th>
            <th colspan="2">Action</th>
        </tr>
        </thead>
        <tbody>
                <tr th:each="size, iterStat : ${listSize}" th:id="'row-' + ${size.id}" >
                    <td th:text="${iterStat.index+1}"></td>
                    <td th:text="${size.name}"></td>
                    <td th:text="${#dates.format(size.createdAt,'dd-MM-yyyy')}"></td>
                    <td th:text="${#dates.format(size.updatedAt,'dd-MM-yyyy')}"></td>
                    <td class="center">
                        <button type="button" th:onclick="'deleteCate(' + ${size.id} + ')'" class="btn btn-danger"><i
                                class="fa fa-trash-o  fa-fw"></i></button>
                    </td>
                    <td class="center">
                        <button type="button" id="btn-initupdate"
                                class="btn btn-success btn-edit" data-toggle="modal" data-target="#exampleModal"
                                data-whatever="@mdo" th:data-id="${size.id}" th:data-name="${size.name}"><i  class="fa fa-pencil fa-fw"></i></button>
                    </td>
                </tr>
        </tbody>

    </table>
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="updateForm" method="post" action="/admin/size/update" th:object="${size}">
                        <div class="modal-body">
                            <input type="hidden" id="sizeId" name="sizeId">
                            <div class="form-group">
                                <label class="col-form-label">New size name:</label>
                                <input type="text" class="form-control categoryName" id="newSizeName" th:field="*{name}">
                                <span style="color: red" id="errors" ></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success" id="btn-update">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script>
            const updateButtons = document.querySelectorAll('.btn-edit');
            const newName = document.getElementById("newSizeName")
            const cateId = document.getElementById("sizeId")
            // gán giá trị hiện tại của category cần sửa vào form update
            updateButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    var dataId = this.dataset.id;
                    var dataName = this.dataset.name;
                    newName.value = dataName;
                    cateId.value = dataId;
                });
            });
            const form = document.getElementById('updateForm');
            const errorsSpan = document.getElementById('errors');
            // Thêm sự kiện submit cho form
            form.addEventListener('submit', function(event) {
                // Ngăn chặn hành động mặc định (gửi form) nếu có lỗi
                if (!validateForm()) {
                    event.preventDefault(); // Ngăn chặn gửi form
                }
            });
            // Validate name category không được để trống
            function validateForm() {
                let isValid = true;
                var nameValue = newName.value.trim();
                // Xóa lỗi trước khi kiểm tra
                errorsSpan.innerHTML = "";

                // Kiểm tra xem trường tên có trống không
                if (nameValue == "") {
                    errorsSpan.innerHTML = 'Size name cannot be empty.';
                    isValid = false;
                }
                return isValid;
            }

            // Hàm delete xử lý bằng ajax
            function deleteCate(id){
                Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        // thực hiện ajax
                        fetch(`/admin/size/delete/` +id, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => {
                                if (response.ok) {
                                    const row = document.getElementById(`row-`+id);
                                    if (row) {
                                        row.remove();
                                    }
                                    Swal.fire({
                                        title: "Deleted!",
                                        text: "Your size has been deleted.",
                                        icon: "success"
                                    });
                                } else {
                                    throw new Error('Failed to delete the Size');
                                }
                            })
                    }
                });
            }
        </script>
    </div>
</body>
</html>